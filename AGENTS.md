# cryptow エージェント設計メモ

## 目的
平文で認証情報を保存する既存CLIを安全にラップし、gocryptfsを用いた透過的な暗号化ストレージを提供する。

## コアコンセプト
- 各CLIを"プロファイル"として定義し、対象バイナリ、保護すべきファイル／ディレクトリ、環境変数上書きを記述する。
- プロファイル単位で暗号化ストアとマウント先を設定可能とする。ストアはデフォルト値を持つ。`~/.local/share/cryptow/profiles/<profile>/cipher`とか
- `cryptow run <profile> [-- ...]` をエントリポイントとし、プロファイル情報を読み込み、必要なマウントを行って対象CLIを実行する。

## 実行フロー
1. プロファイルを読み込み、暗号化ストアパス、マウント先、対象コマンド、追加の環境変数を解決する。
2. マウント先が未マウントであることを PID ファイルとロックファイルで確認し、未マウントなら `gocryptfs` を起動する。
3. 取得したマウントポイントを使って対象CLIを実行し、標準入出力／終了コードは透過的に扱う。
4. コマンド終了後は常にアンマウントし、ロックと PID ファイルを削除する。

## マウント管理
- リファレンスカウントは持たず、単純に起動時マウント／終了時アンマウントの一往復とする。
- 多重起動防止のため、PID ファイルとロックファイルでマウント状態を判定し、すでにマウントされている場合はエラーとして扱う（`--force` 等で上書き可能）。
- マウント／アンマウントの各コマンド実行結果をログに記録し、トラブルシュートを容易にする。

## 認証情報の扱い
- 暗号化パスワードは `pass` からのみ取得する。プロファイルに `password_entry` を必須フィールドとして持たせ、`pass show <entry>` に失敗した場合は即座にエラー終了させる。
- 対話入力や他キーチェーンとの連携は扱わない。

## CLI インターフェース
- `run`, `list`, `mount`, `unmount` といったサブコマンドを想定。
- `list`: 登録済みプロファイルの列挙。現在マウント中かどうかも表示する。

## 追加機能
- ドライランモードで、マウント対象や変更される環境変数を事前確認できるようにする。
- ラッパーの操作ログを `~/.local/share/cryptow/log` に保存し、標準出力とは分離する。

## 非対応領域
- 他の暗号化ファイルシステムへの拡張やプラグイン機構などの拡張性については現段階では考慮しない。

